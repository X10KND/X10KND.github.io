<!DOCTYPE html>
<html>
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        canvas {
            margin: 20px;
        }
        html,
        body {
            overscroll-behavior-y: contain;
            height: 100%;
        }
        body {
            background-color: #000518;
            margin: 0;
        }
        .row-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 5px;
        }
        .column-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        h1 {
            color: #FFF;
            font-family: Arial;
        }
        h2 {
            color: #FFF;
            font-family: Arial;
        }
        .main-button {
            background-color: white;
            border: none;
            color: #000518;
            font-family: Arial;
            padding: 10px;
            display: inline-block;
            border-radius: 10px;
            font-size: 20px;
        }
        .main-button:active {
            background-color: #aaa;
        }
        i {
            color: #fff;
            margin: 15px;
        }
        i:active {
            color: #aaa;
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="column-wrapper">
        <div class="row-wrapper">
            <h1 style="margin-bottom: 0px;in">N Puzzle</h1>
        </div>
        <div class="row-wrapper">
            <canvas id="board" style="border:3px solid #FFF;"></canvas>
        </div>
        <div class="row-wrapper">
            <button class="main-button" onclick="newGame()"><b>New Game</b></button>
        </div>
        <div class="row-wrapper">
            <i class="fa-solid fa-circle-minus fa-xl" onclick="decreaseSize()"></i>
            <h2 id="board-text">Board Size 3x3</h2>
            <i class="fa-solid fa-circle-plus fa-xl" onclick="increaseSize()"></i>
        </div>
        <div class="row-wrapper">
            <i class="fa-brands fa-github fa-2xl"></i>
        </div>
    </div>
</body>
<script>
    
    if (screen.width > screen.height) {
        var scale = screen.width / 5;
    }
    else {
        var scale = screen.width / 1.5;
    }

    var padding = 5;

    var n = 3; //Board size n x n
    var minSize = 2;
    var maxSize = 10;

    var animationSteps = 20;

    var canvas = document.getElementById("board");
    var ctx = canvas.getContext("2d");

    var boardText = document.getElementById("board-text");

    var pieceWidth = 0;

    var pieces = [];
    var blocks = [];
    var numbers = [];

    var prevBlankPosition = 0;
    var blankPosition = 0;

    var backgroundColour = "#000518";
    var matchedPieceColour = "#7F7";
    var unmatchedPieceColour = "#FFF"

    initialize();

    function initialize() {

        canvas.width = n * Math.floor(scale / n) + (n + 1) * padding;
        canvas.height = n * Math.floor(scale / n) + (n + 1) * padding;

        pieceWidth = Math.floor(scale / n);

        ctx.font = Math.floor(pieceWidth / 2) + "px Arial";

        boardText.innerText = "Board Size " + n + "x" + n;

        pieces = [];
        for (var i = 1; i < n * n; i++) {
            pieces.push(i);
        }
        pieces.push(0);

        blocks = [];
        numbers = [];

        prevBlankPosition = pieces.length - 1;
        blankPosition = pieces.length - 1;

        addBlocks();
        addNumbers();
        shuffle();
        render();
    }

    function increaseSize() {
        if (n < maxSize) {
            n++;
            initialize();
        }
    }

    function decreaseSize() {
        if (n > minSize) {
            n--;
            initialize();
        }
    }

    function newGame() {
        if (confirm("Are you sure you want to start a new game?")) {
            shuffle();
            render();
        }
    }

    var canvasLeft = canvas.offsetLeft + canvas.clientLeft;
    var canvasTop = canvas.offsetTop + canvas.clientTop;

    canvas.addEventListener('click', function(event) {

        var xPos = event.pageX - canvasLeft;
        var yPos = event.pageY - canvasTop;

        blocks.forEach(function(block) {
            if (yPos > block.top && yPos < block.top + block.height && xPos > block.left && xPos < block.left + block.width) {

                var clickY = Math.round((block.top - padding) / (padding + pieceWidth));
                var clickX = Math.round((block.left - padding) / (padding + pieceWidth));

                var blankY = Math.floor(blankPosition / n);
                var blankX = blankPosition % n;

                if (clickX == blankX) {
                    var diff = clickY - blankY;
                    if (diff < 0) {
                        for (var i = 1; i <= Math.abs(diff); i++) {
                            move(40, true);
                        }
                    }
                    else if (diff > 0) {
                        for (var i = 1; i <= diff; i++) {
                            move(38, true);
                        }
                    }
                }
                else if (clickY == blankY) {
                    var diff = clickX - blankX;
                    if (diff < 0) {
                        for (var i = 1; i <= Math.abs(diff); i++) {
                            move(39, true);
                        }
                    }
                    else if (diff > 0) {
                        for (var i = 1; i <= diff; i++) {
                            move(37, true);
                        }
                    }
                }

            }
        });

    }, false);

    function move(key, slide) {

        var y = Math.floor(blankPosition / n);
        var x = blankPosition % n;

        movedFlag = false;
        
        if (key == 40) {
            if (y > 0) {
                pieces[blankPosition] = pieces[(y - 1) * n + x];
                prevBlankPosition = blankPosition;
                blankPosition = (y - 1) * n + x;
                pieces[blankPosition] = 0;
                movedFlag = true;
            }
        }
        else if (key == 38) {
            if (y < n - 1) {
                pieces[blankPosition] = pieces[(y + 1) * n + x];
                prevBlankPosition = blankPosition;
                blankPosition = (y + 1) * n + x;
                pieces[blankPosition] = 0;
                movedFlag = true;
            }
        }
        else if (key == 39) {
            if (x > 0) {
                pieces[blankPosition] = pieces[y * n + (x - 1)];
                prevBlankPosition = blankPosition;
                blankPosition = y * n + (x - 1);
                pieces[blankPosition] = 0;
                movedFlag = true;
            }
        }
        else if (key == 37) {
            if (x < n - 1) {
                pieces[blankPosition] = pieces[y * n + (x + 1)];
                prevBlankPosition = blankPosition;
                blankPosition = y * n + (x + 1);
                pieces[blankPosition] = 0;
                movedFlag = true;
            }
        }

        if (movedFlag) {

            var new_y = Math.floor(prevBlankPosition / n);
            var new_x = prevBlankPosition % n;

            var old_y = Math.floor(blankPosition / n);
            var old_x = blankPosition % n;

            var blankBlock = (pieces[blankPosition] + (n * n) - 1) % (n * n);
            var prevBlankBlock = (pieces[prevBlankPosition] + (n * n) - 1) % (n * n);

            if (slide) {

                blocks[blankBlock].top = old_y * (padding + pieceWidth) + padding;
                blocks[blankBlock].left = old_x * (padding + pieceWidth) + padding;

                var metrics = ctx.measureText(numbers[prevBlankBlock].text);
                var fontHeight = metrics.actualBoundingBoxAscent  + metrics.actualBoundingBoxDescent;
                var fontWidth = metrics.width;

                var current_number_top = numbers[prevBlankBlock].top;
                var current_number_left = numbers[prevBlankBlock].left;

                var current_block_top = blocks[prevBlankBlock].top;
                var current_block_left = blocks[prevBlankBlock].left;

                var number_target_top = new_y * (padding + pieceWidth) + padding + (pieceWidth + fontHeight) * 0.5;
                var number_target_left = new_x * (padding + pieceWidth) + padding + (pieceWidth - fontWidth) * 0.5;

                var block_target_top = new_y * (padding + pieceWidth) + padding;
                var block_target_left = new_x * (padding + pieceWidth) + padding;

                var number_top_steps = (number_target_top - current_number_top) / animationSteps;
                var number_left_steps = (number_target_left - current_number_left) / animationSteps;

                var block_top_steps = (block_target_top - current_block_top) / animationSteps;
                var block_left_steps = (block_target_left - current_block_left) / animationSteps;

                blocks[prevBlankBlock].colour = unmatchedPieceColour;

                for (var i = 1; i <= animationSteps; i++) {
                    setTimeout(function() {
                        numbers[prevBlankBlock].top += number_top_steps;
                        numbers[prevBlankBlock].left += number_left_steps;

                        blocks[prevBlankBlock].top += block_top_steps;
                        blocks[prevBlankBlock].left += block_left_steps;
                        render();
                    }, i);
                }

                if (pieces[prevBlankBlock] == prevBlankBlock + 1) {
                    blocks[prevBlankBlock].colour = matchedPieceColour;
                }

                render();

            }
            else {

                var metrics = ctx.measureText(numbers[prevBlankBlock].text);
                var fontHeight = metrics.actualBoundingBoxAscent  + metrics.actualBoundingBoxDescent;
                var fontWidth = metrics.width;

                numbers[prevBlankBlock].top = new_y * (padding + pieceWidth) + padding + (pieceWidth + fontHeight) * 0.5;
                numbers[prevBlankBlock].left = new_x * (padding + pieceWidth) + padding + (pieceWidth - fontWidth) * 0.5;


                blocks[blankBlock].top = old_y * (padding + pieceWidth) + padding;
                blocks[blankBlock].left = old_x * (padding + pieceWidth) + padding;

                blocks[prevBlankBlock].colour = unmatchedPieceColour;

                blocks[prevBlankBlock].top = new_y * (padding + pieceWidth) + padding;
                blocks[prevBlankBlock].left = new_x * (padding + pieceWidth) + padding;

                if (pieces[prevBlankBlock] == prevBlankBlock + 1) {
                    blocks[prevBlankBlock].colour = matchedPieceColour;
                }

            }
        }
    }

    function shuffle() {
        for (var i = 0; i < 10000; i++) {
            var randomMove = Math.floor(Math.random() * 4) + 37;
            move(randomMove, false);
        }
        for (var i = 0; i < n; i++) {
            move(37, false);
            move(38, false);
        }
    }

    function addBlocks() {

        for (var i = 0; i < n * n; i++) {

            var y = Math.floor(i / n);
            var x = i % n;

            var colour = (pieces[i] == i + 1) ? matchedPieceColour : unmatchedPieceColour;

            if (pieces[i] == 0) {
                colour = backgroundColour;
            }

            blocks.push({
                colour: colour,
                width: pieceWidth,
                height: pieceWidth,
                top: y * (padding + pieceWidth) + padding,
                left: x * (padding + pieceWidth) + padding,
            });
            
        }
    }

    function addNumbers() {

        for (var i = 0; i < n * n; i++) {

            var y = Math.floor(i / n);
            var x = i % n;

            var metrics = ctx.measureText(pieces[i]);
            var fontHeight = metrics.actualBoundingBoxAscent  + metrics.actualBoundingBoxDescent;
            var fontWidth = metrics.width;

            numbers.push({
                colour: backgroundColour,
                text: (pieces[i]) == 0 ? "" : pieces[i],
                top: y * (padding + pieceWidth) + padding + (pieceWidth + fontHeight) * 0.5,
                left: x * (padding + pieceWidth) + padding + (pieceWidth - fontWidth) * 0.5,
            });
            
        }
    }

    function render() {

        ctx.fillStyle = backgroundColour;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        blocks.forEach(function(block) {

            if (block.colour != backgroundColour) {
                ctx.fillStyle = block.colour;
                ctx.fillRect(block.left, block.top, block.width, block.height);
            }
        });

        numbers.forEach(function(number) {
            ctx.fillStyle = number.colour;
            ctx.fillText(number.text, number.left, number.top);
        });

    }

    document.addEventListener('keydown', function(event) {
        move(event.keyCode, true);
    });

    document.addEventListener('touchstart', handleTouchStart, false);
    document.addEventListener('touchmove', handleTouchMove, false);

    var xDown = null;
    var yDown = null;

    function getTouches(evt) {
        return evt.touches || evt.originalEvent.touches;
    }
    
    function handleTouchStart(evt) {
        const firstTouch = getTouches(evt)[0];
        xDown = firstTouch.clientX;
        yDown = firstTouch.clientY;
    }
    
    function handleTouchMove(evt) {
        if (!xDown || !yDown) {
            return;
        }

        var xUp = evt.touches[0].clientX;
        var yUp = evt.touches[0].clientY;

        var xDiff = xDown - xUp;
        var yDiff = yDown - yUp;

        if (Math.abs(xDiff) > Math.abs(yDiff)) {
            if (xDiff > 0) {
                move(37, true);
            }
            else {
                move(39, true);
            }
        } else {
            if (yDiff > 0) {
                move(38, true);
            }
            else { 
                move(40, true);
            } 
        }
        
        xDown = null;
        yDown = null;
    }
    
</script>
</html>